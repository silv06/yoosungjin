permissions:
  contents: read
  id-token: write

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:      # <--- 이 부분이 있어야 버튼이 생깁니다!

jobs:
  run-gee-analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. 여기서 로그인을 대신 해줍니다. (이 단계가 필수!)
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: '${{ secrets.GEE_SERVICE_ACCOUNT_KEY }}'

      # 2. 파이썬 버전을 3.10으로 올리세요 (경고 제거용)
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' 

      # 3. 라이브러리 설치
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install earthengine-api pandas supabase google-auth

      # 4. 실행
      - name: Run analysis script
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          # 팁: GEE 프로젝트 ID도 환경 변수로 빼두면 좋습니다 (선택사항)
          EE_PROJECT_ID: 'absolute-cache-478407-p5' 
          EE_SERVICE_ACCOUNT_KEY: ${{ secrets.GEE_SERVICE_ACCOUNT_KEY}}
        run: python main.py